name: Deploy All Environments (only Terraform, e.g. Lambda deploys or -aws repos)

on:
  workflow_call:
    inputs:
      has-application-changes:
        description: All changes in application and infrastructure
        type: boolean
        required: false
        default: true
      terraform-changes:
        type: string
        required: false
        default: '["Service", "Test", "Stage", "Production"]' # Assume all environments have changes if not specified
      working-directory:
        description: "Directory containing the project files"
        required: false
        type: string
        default: "."
      terraform-directory:
        description: Directory where Terraform environment directories are located
        type: string
        required: false
        default: ""
      sha-to-deploy:
        description: The SHA to deploy. If not provided, the current commit SHA will be used.
        type: string
        required: false
        default: ${{ github.sha }} # Assume this workflow is only run in main branches
      skip-test-environment:
        description: Skip the test environment, if the repository does not deploy to the test environment.
        type: boolean
        default: false
        required: false
      skip-service-environment:
        description: '[DEPRECATED] This parameter no longer has any effect. Service environment is automatically skipped if no terraform directory exists.'
        type: boolean
        default: false
        required: false
      skip-production-environment:
        description: Skip the production environment, if the repository does not deploy to the production environment.
        type: boolean
        default: false
        required: false
      aws-role-name-to-assume:
        description: "The AWS role name to assume. Used for migration purposes for teams using older GHA roles."
        required: false
        type: string
        default: ${{ vars.AWS_DEPLOYMENT_ROLE_NAME }}
      version-handler-api-endpoint:
        description: "Version handler API endpoint for artifact versioning. Use ONLY if testing the deployment pipeline"
        required: false
        type: string

run-name: Deploy Environments

jobs:
  get-environments:
    name: Find Relevant GH Environments
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.envs.outputs.environments }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - uses: nsbno/platform-actions/.github/actions/helpers/get-environments@v2
        id: envs
        with:
          working-directory: ${{ inputs.working-directory }}
          terraform-directory: ${{ inputs.terraform-directory }}
          skip-production-environment: ${{ inputs.skip-production-environment }}
          skip-test-environment: ${{ inputs.skip-test-environment }}

  # Service always needs to be deployed first, and we only deploy Terraform changes.
  service-terraform:
    name: Service - Terraform
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-terraform.yml@v2
    needs: get-environments
    if: |
      always()
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && contains(needs.get-environments.outputs.environments, 'Service')
    with:
      environment: Service
      deploy-terraform: ${{ contains(fromJSON(inputs.terraform-changes), 'Service') }}
      working-directory: ${{ inputs.working-directory }}
      terraform-directory: ${{ inputs.terraform-directory }}
      version-handler-api-endpoint: ${{ inputs.version-handler-api-endpoint }}

  test-terraform:
    name: Test - Terraform
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-terraform.yml@v2
    needs:
      - service-terraform
      - get-environments
    if: |
      always()
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && contains(needs.get-environments.outputs.environments, 'Test')
    with:
      environment: Test
      deploy-terraform: ${{ contains(fromJSON(inputs.terraform-changes), 'Test') }}
      working-directory: ${{ inputs.working-directory }}
      terraform-directory: ${{ inputs.terraform-directory }}
      version-handler-api-endpoint: ${{ inputs.version-handler-api-endpoint }}

  stage-terraform:
    name: Stage - Terraform
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-terraform.yml@v2
    needs:
      - service-terraform
      - get-environments
    if: |
      always()
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && contains(needs.get-environments.outputs.environments, 'Stage')
    with:
      environment: Stage
      deploy-terraform: ${{ contains(fromJSON(inputs.terraform-changes), 'Stage') }}
      working-directory: ${{ inputs.working-directory }}
      terraform-directory: ${{ inputs.terraform-directory }}
      version-handler-api-endpoint: ${{ inputs.version-handler-api-endpoint }}

  production-terraform:
    name: Prod - Terraform
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-terraform.yml@v2
    needs:
      - stage-terraform
      - test-terraform
    if: |
      always()
      && !cancelled()
      && !inputs.skip-production-environment
      && !contains(needs.*.result, 'failure')
      && contains(needs.get-environments.outputs.environments, 'Production')
    with:
      environment: Production
      deploy-terraform: ${{ contains(fromJSON(inputs.terraform-changes), 'Production') }}
      working-directory: ${{ inputs.working-directory }}
      terraform-directory: ${{ inputs.terraform-directory }}
      version-handler-api-endpoint: ${{ inputs.version-handler-api-endpoint }}
