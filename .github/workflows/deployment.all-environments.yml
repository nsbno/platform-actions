name: Deploy All Environments

on:
  workflow_call:
    inputs:
      applications:
        description: The name of the application in your Terraform configuration. Comma-separated.
        type: string
        required: false
      has-application-changes:
        description: All changes in application and infrastructure
        type: boolean
        required: false
        default: true
      terraform-changes:
        type: string
        required: false
        default: '[Service, Test, Stage, Production]' # Assume all environments have changes if not specified
      working-directory:
        description: "Directory containing the project files"
        required: false
        type: string
        default: "."
      terraform-directory:
        description: Directory where Terraform environment directories are located
        type: string
        required: false
        default: ''
      sha-to-deploy:
        description: The SHA to deploy. If not provided, the current commit SHA will be used.
        type: string
        required: false
        default: ${{ github.sha }} # Assume this workflow is only run in main branches
      skip-service-environment:
        description: Skip the service environment, if the repository does not deploy to the service environment.
        type: boolean
        default: false
        required: false
      skip-static-files-deployment:
        description: Skip deployment of static files to S3 (if applicable). Used if application is built in Dockerfile.
        type: boolean
        default: false
        required: false
      aws-role-name-to-assume:
        description: "The AWS role name to assume. Used for migration purposes for teams using older GHA roles."
        required: false
        type: string
        default: ${{ vars.AWS_DEPLOYMENT_ROLE_NAME }}
      lambda-file-extension:
        description: File extension for Lambda deployment package (zip or jar)
        type: string
        required: false

run-name: Deploy Environments

jobs:
  send-tracking-started:
    name: Send "started" metric to DORA service
    uses: nsbno/platform-actions/.github/workflows/helpers.deployment-tracking.yml@lambda-deploy
    with:
      status: started
      tracking-type: dora
      aws-role-name-to-assume: ${{ inputs.aws-role-name-to-assume }}

  get-environments:
    name: Find Relevant GH Environments
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.envs.outputs.environments }}
      application-names: ${{ steps.parse-app-names.outputs.apps_json }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - uses: nsbno/platform-actions/.github/actions/helpers/get-environments@v1
        id: envs
        with:
          skip-service-environment: ${{ inputs.skip-service-environment }}
      - name: Parse application names
        id: parse-app-names
        run: |
          APPS_JSON=$(echo '${{ inputs.applications }}' | jq -Rc 'split(",") | map(select(length > 0) | ltrimstr(" ") | rtrimstr(" "))')
          echo "apps_json=${APPS_JSON}" >> $GITHUB_OUTPUT

  # Service always needs to be deployed first, and we only deploy Terraform changes.
  service-terraform:
    name: Service - Terraform
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-terraform.yml@lambda-deploy
    needs: get-environments
    if: |
      always()
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && contains(needs.get-environments.outputs.environments, 'Service')
    strategy:
      matrix:
        # Matrix gives better visibility in GH UI
        environment: [ Service ]
    with:
      environment: ${{ matrix.environment }}
      deploy-terraform: ${{ contains(fromJSON(inputs.terraform-changes), 'Service') }}
      working-directory: ${{ inputs.working-directory }}
      terraform-directory: ${{ inputs.terraform-directory }}
      sha-to-deploy: ${{ inputs.sha-to-deploy }}

  test-terraform:
    name: Test - Terraform
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-terraform.yml@lambda-deploy
    needs:
      - service-terraform
      - get-environments
    if: |
      always()
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && contains(needs.get-environments.outputs.environments, 'Test')
    strategy:
      matrix:
        # Matrix gives better visibility in GH UI
        environment: [ Test ]
    with:
      environment: ${{ matrix.environment }}
      deploy-terraform: ${{ contains(fromJSON(inputs.terraform-changes), 'Test') }}
      working-directory: ${{ inputs.working-directory }}
      terraform-directory: ${{ inputs.terraform-directory }}
      sha-to-deploy: ${{ inputs.sha-to-deploy }}

  test-application:
    name: Test - Application
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-application.yml@lambda-deploy
    needs:
      - test-terraform
      - get-environments
    if: |
      always()
      && inputs.applications
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && needs.test-terraform.result != 'failure'
      && contains(needs.get-environments.outputs.environments, 'Test')
    strategy:
      matrix:
        application-name: ${{ fromJSON(needs.get-environments.outputs.application-names) }}
    with:
      application-name: ${{ matrix.application-name }}
      environment: Test
      deploy-application: ${{ inputs.has-application-changes }}
      sha-to-deploy: ${{ inputs.sha-to-deploy }}
      lambda-file-extension: ${{ inputs.lambda-file-extension }}
      skip-s3-deployment: ${{ inputs.skip-static-files-deployment }}

  stage-terraform:
    name: Stage - Terraform
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-terraform.yml@lambda-deploy
    needs:
      - service-terraform
      - get-environments
    if: |
      always()
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && contains(needs.get-environments.outputs.environments, 'Stage')
    strategy:
      matrix:
        # Matrix gives better visibility in GH UI
        environment: [ Stage ]
    with:
      environment: ${{ matrix.environment }}
      deploy-terraform: ${{ contains(fromJSON(inputs.terraform-changes), 'Stage') }}
      working-directory: ${{ inputs.working-directory }}
      terraform-directory: ${{ inputs.terraform-directory }}
      sha-to-deploy: ${{ inputs.sha-to-deploy }}

  stage-application:
    name: Stage - Application
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-application.yml@lambda-deploy
    needs:
      - stage-terraform
      - get-environments
    if: |
      always()
      && inputs.applications
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && needs.stage-terraform.result != 'failure'
      && contains(needs.get-environments.outputs.environments, 'Stage')
    strategy:
      matrix:
        application-name: ${{ fromJSON(needs.get-environments.outputs.application-names) }}
    with:
      application-name: ${{ matrix.application-name }}
      environment: Stage
      deploy-application: ${{ inputs.has-application-changes }}
      sha-to-deploy: ${{ inputs.sha-to-deploy }}
      lambda-file-extension: ${{ inputs.lambda-file-extension }}
      skip-s3-deployment: ${{ inputs.skip-static-files-deployment }}

  production-terraform:
    name: Prod - Terraform
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-terraform.yml@lambda-deploy
    needs:
      - stage-application
      - stage-terraform
      - test-application
      - test-terraform
    if: |
      always()
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && contains(needs.get-environments.outputs.environments, 'Production')
    strategy:
      matrix:
        # Matrix gives better visibility in GH UI
        environment: [ Production ]
    with:
      environment: ${{ matrix.environment }}
      deploy-terraform: ${{ contains(fromJSON(inputs.terraform-changes), 'Production') }}
      working-directory: ${{ inputs.working-directory }}
      terraform-directory: ${{ inputs.terraform-directory }}
      sha-to-deploy: ${{ inputs.sha-to-deploy }}

  production-application:
    name: Prod - Application
    uses: nsbno/platform-actions/.github/workflows/deployment.single-environment-application.yml@lambda-deploy
    needs:
      - production-terraform
      - get-environments
    if: |
      always()
      && inputs.applications
      && !cancelled()
      && !contains(needs.*.result, 'failure')
      && contains(needs.get-environments.outputs.environments, 'Production')
    strategy:
      matrix:
        application-name: ${{ fromJSON(needs.get-environments.outputs.application-names) }}
    with:
      application-name: ${{ matrix.application-name }}
      environment: Production
      deploy-application: ${{ inputs.has-application-changes }}
      sha-to-deploy: ${{ inputs.sha-to-deploy }}
      lambda-file-extension: ${{ inputs.lambda-file-extension }}
      skip-s3-deployment: ${{ inputs.skip-static-files-deployment }}

  send-tracking-finished:
    name: Send finsihed metric to DORA service
    uses: nsbno/platform-actions/.github/workflows/helpers.deployment-tracking.yml@lambda-deploy
    needs:
      - service-terraform
      - test-terraform
      - test-application
      - stage-terraform
      - stage-application
      - production-terraform
      - production-application
    if: always()
    with:
      status: ${{ (contains(needs.*.result, 'success') || contains(needs.*.result, 'skipped' || contains(needs.*.result, 'neutral'))) && 'succeeded' || 'failed' }}
      tracking-type: dora
      aws-role-name-to-assume: ${{ inputs.aws-role-name-to-assume }}
