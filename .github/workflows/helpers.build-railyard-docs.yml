on:
  workflow_call:
    inputs:
      entity-name:
        required: true
        type: string
        description: "Name of the S3 Folder to publish to."
      mkdocs-directory:
        type: string
        default: .
        description: "The directory containing mkdocs.yml"
      openapi-directory:
        type: string
        default: "generated"
        description: "The folder path where the OpenAPI spec is generated"
      openapi-spec-filename:
        type: string
        default: openapi-metadata.yaml
        description: "The file name for openapi-spec"
      aws-region:
        required: false
        type: string
        description: "AWS region to use."
        default: 'eu-west-1'
      artifact-name:
        type: string
        default: "application-build"
        description: "Name of the artifact containing the built application"

name: Build and Upload Railyard TechDocs to S3

permissions:
  id-token: write
  contents: read

jobs:
  build-mkdocs:
    name: Build mkdocs
    environment: Service
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Install mkdocs and plugins
        run: |
          python -m pip install --upgrade pip && pip install mkdocs mkdocs-techdocs-core
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build mkdocs
        run: cd ${{ inputs.mkdocs-directory }} && python -m mkdocs build

      - name: Create the railyard folder if it doesn't exist
        run: mkdir -p railyard/default/component/${{inputs.entity-name}}

      - name: Save the new site
        run: mv site/* railyard/default/component/${{inputs.entity-name}}

      - name: Authenticate with AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_DEPLOYMENT_ROLE_NAME }}"

      - name: Upload to S3
        env:
          S3_BUCKET: "471112960535-railyard-artifacts"
          ENTITY_NAME: ${{inputs.entity-name}}
        run: |
          aws s3 sync "./railyard/default/component/${{inputs.entity-name}}" "s3://$S3_BUCKET/default/component/$ENTITY_NAME/"

  update-openapi-spec:
    name: Update OpenAPI Spec
    environment: Service
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: artifact-download

      - name: Check OpenAPI spec exists
        id: check-file
        run: |
          # Check for the OpenAPI spec file
          FILE_PATH="artifact-download/${{ inputs.openapi-directory }}/${{ inputs.openapi-spec-filename }}"
          
          echo "Checking for OpenAPI spec at: $FILE_PATH"
          if [ -f "$FILE_PATH" ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
            echo "âœ“ Found OpenAPI spec file"
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "ERROR: OpenAPI spec file not found: ${{ inputs.openapi-spec-filename }}"
            exit 1
          fi

      - name: Create the railyard openapi folder if it doesn't exist
        if: steps.check-file.outputs.file_exists == 'true'
        run: mkdir -p railyard/openapi/${{inputs.entity-name}}

      - name: Copy openapi-spec to railyard/openapi/${{inputs.entity-name}}
        if: steps.check-file.outputs.file_exists == 'true'
        run: cp "${{ steps.check-file.outputs.file_path }}" railyard/openapi/${{inputs.entity-name}}/openapi-definition.yaml

      - name: Authenticate with AWS
        if: steps.check-file.outputs.file_exists == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ inputs.aws-region }}
          role-to-assume: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_DEPLOYMENT_ROLE_NAME }}"

      - name: Upload OpenAPI spec to S3
        if: steps.check-file.outputs.file_exists == 'true'
        env:
          S3_BUCKET: "471112960535-railyard-artifacts"
          ENTITY_NAME: ${{inputs.entity-name}}
        run: |
          aws s3 sync "./railyard/openapi/${{inputs.entity-name}}" "s3://$S3_BUCKET/openapi/$ENTITY_NAME/"
