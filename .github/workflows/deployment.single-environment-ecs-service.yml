name: Deploy ECS Service/SSR Service

on:
  workflow_call:
    inputs:
      working-directory:
        description: If monorepo. Directory where the service is located.
        type: string
        required: false
        default: ""
      environment:
        description: Environment to deploy
        type: string
        required: true
      deploy-application:
        description: Should application be deployed
        type: boolean
        required: true
      sha-to-deploy:
        description: SHA to deploy, defaults to the current commit
        type: string
        required: false
        default: ${{ github.event.pull_request.head.sha || github.sha }}
      skip-s3-deployment:
        description: Skip S3 deployment for static files
        type: boolean
        required: false
        default: false

run-name: Deploy to ${{ inputs.environment }}

permissions:
  contents: read
  id-token: write

concurrency:
  group: ${{ inputs.environment }}-deploy-${{ inputs.ecs-service-name }}
  cancel-in-progress: true

jobs:
  ecs-service:
    name: ${{ inputs.ecs-service-name }} (${{ inputs.environment }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    if: |
      inputs.deploy-application
      && always()
      && !cancelled()
      && !contains(needs.*.result, 'failure')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: '0' # Fetch all history for all branches and tags (for branch deploys)
          ref: ${{ inputs.sha-to-deploy }}

      - name: Authenticate with AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_DEPLOYMENT_ROLE_NAME }}"

      - name: Get Application Deployment Information
        id: deployment-info
        uses: nsbno/platform-actions/.github/actions/deployment/get-application-deployment-info@autodiscovery
        with:
          github-repository-name: ${{ github.repository }}
          working-directory: ${{ inputs.working-directory }}

      # Needs to be available before the frontend server deploys
      - name: Deploy Static S3/Website
        if: steps.deployment-info.outputs.static-files-bucket-name != '' && !inputs.skip-s3-deployment
        uses: nsbno/platform-actions/.github/actions/deployment/static-files/upload-build-to-s3@autodiscovery
        with:
          s3-bucket-name: ${{ steps.deployment-info.outputs.static-files-bucket-name }}
          git-sha: '${{ inputs.sha-to-deploy }}'

      - name: Deploy ECS
        if: steps.deployment-info.outputs.compute-target == 'ecs'
        uses: nsbno/platform-actions/.github/actions/deployment/deploy-ecs@autodiscovery
        with:
          cluster-name: ${{ steps.deployment-info.outputs.ecs-cluster-name }}
          image-uri: "${{ steps.deployment-info.outputs.ecr-image-base }}:${{ inputs.sha-to-deploy }}"
          ecs-service-name: ${{ steps.deployment-info.outputs.ecs-service-name }}
          ecs-container-name: ${{ steps.deployment-info.outputs.ecs-container-name }}
          ecs-container-port: ${{ steps.deployment-info.outputs.ecs-container-port }}
          aws-account-id: ${{ vars.AWS_ACCOUNT_ID }}
          sha-version: ${{ inputs.sha-to-deploy }}

      - name: Register ECS Version to deployment version handler
        uses: nsbno/platform-actions/.github/actions/helpers/register-version@autodiscovery
        with:
          operation: register-version
          compute-target: "ecs"
          working-directory: ${{ inputs.working-directory }}
